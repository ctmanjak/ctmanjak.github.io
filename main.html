<html>
	<head>
		<meta charset="utf-8">
		<link type="text/css" href="style.css" rel="stylesheet">
	</head>
	<body>
		<style id="movebg">
			@keyframes movebg
			{
				from{background-position:0px 0px;}
				to{background-position:-500px 0px;}
			}
		</style>
		<div class="startgame">
			<input type="button" id="startgamebt" value="게임시작">
		</div>
		<div class="front">
		</div>
		<div class="frame">
			<div class="player_info_frame">
				<div class="player_info">
					<div class="player_info_name">
						<span id="char_name">?</span>
					</div>
					<center>
					<input type="button" id="save" value="저장">
					<input type="button" id="load" value="불러오기">
					</center>
					<div class="player_info_lvlxp">레벨 : <span id="level">0</span> 경험치 : <span id="exp_level">0</span>/<span id="lvlup_exp">0</span></div>
					<div class="player_info_stat">
						<div class="player_stat">힘 : <span id="stat_str">0</span><br>민첩 : <span id="stat_agi">0</span><br>지능 : <span id="stat_int">0</span><br>인내 : <span id="stat_end">0</span></div>
						<div class="inc_stat hide"><input type="button" id="stat_str" value="+"><br><input type="button" id="stat_agi" value="+"><br><input type="button" id="stat_int" value="+"><br><input type="button" id="stat_end" value="+"></div>
						SP : <span id="sp">0</span><br>
						HP : <span id="hp">0</span> / <span id="max_hp">0</span><br>MP : <span id="mp">0</span> / <span id="max_mp">0</span><br>공격력 : <span id="ad">0</span><br>공격속도 : <span id="as">0</span><br>
						방어력 : <span id="armor">0</span><br>마법저항력 : <span id="resist">0</span><br>돈 : <span id="money">0</span>
					</div>
				</div>
			</div>
			<!--<div class="player_list">
			</div>-->
			<div class="player_effect effect_list">
				<ul id="passive"></ul>
				<div style="margin:0px"></div>
				<ul id="active"></ul>
			</div>
			<div class='effect_detail hide'><div class='effect_intensity'></div></div>
			<div class="item_detail hide"><div class="item_header"><div class="item_name"></div><div class="item_slot"></div></div><div class="item_content"><div class="h_line"></div><div class="item_desc"></div><div class="h_line"></div><div class="item_effect"><div class="item_duration"></div><ul></ul></div></div></div>
			<div class="npc_info_frame">
				<div class="npc_info">
					<ul>
						
					</ul>
					<div class="npc_info_name">
						<span id="char_name">?</span>
					</div>
					<div class="npc_info_lvlxp">레벨 : <span id="level">?</span></div>	
					<div class="npc_info_stat">
						<div class="npc_stat">힘 : <span id="stat_str">?</span><br>민첩 : <span id="stat_agi">?</span><br>지능 : <span id="stat_int">?</span><br>인내 : <span id="stat_end">?</span></div><br>
						<div class="inc_stat hide"><input type="button" id="stat_str" value="+"><br><input type="button" id="stat_agi" value="+"><br><input type="button" id="stat_int" value="+"><br><input type="button" id="stat_end" value="+"></div>
						HP : <span id="hp">?</span> / <span id="max_hp">?</span><br>MP : <span id="mp">?</span> / <span id="max_mp">?</span><br>공격력 : <span id="ad">?</span><br>공격속도 : <span id="as">?</span><br>
						방어력 : <span id="armor">?</span><br>마법저항력 : <span id="resist">?</span>
					</div>
				</div>
			</div>
			<div class="npc_list">
				<div style="text-align:right;position:absolute;padding:0;margin:0;top:0;right:0;font-size:0.8em">NPC</div>
				<ul>
					
				</ul>
			</div>
			<div class="follower_list">
				<div style="text-align:right;position:absolute;padding:0;margin:0;top:0;right:0;font-size:0.8em">동료</div>
				<ul>
				
				</ul>
			</div>
			<div class="npc_effect effect_list">
				<ul id="passive">
				
				</ul>
				<ul id="active">
				
				</ul>
			</div>
			<div class="gamescreen">
				<div class="location_info">
					<div class="location_name">
					</div>
				</div>
				<div class="background">
					<div class="bgimg"></div>
				</div>
			</div>
			<div class="dialogue_frame">
				<div class="dialogue_image">
				</div>
				<div class="dialogue_text">
					<div class="dialogue_name">
					</div>
					<div class="dialogue_content">
					</div>
					<div class="dialogue_select">
						<ul>
						
						</ul>
					</div>
				</div>
			</div>
			<div class="user_control">
				<div class="control_category">
					<ul>
						<li class="active" id="controlbox">명령</li><li id="player_inventory">인벤토리</li><li id="active_unit_inventory">선택 유닛 인벤토리</li><li id="quest">퀘스트</li>
					</ul>
				</div>
				<div class="controlscreen">
					<div class="controlbox">
						<input type="button" id="test" value="TEST">
						<input type="button" id="explore" value="탐험">
						<input type="button" class="hide" id="meet" value="방문">
						<input type="button" id="attack" value="공격">
						<input type="button" class="hide" id="dialogue" value="대화">
						<input type="button" class="hide" id="main_location" value="나가기">
						<input type="button" class="" id="move_location" value="지역 이동">
					</div>
					<div class="player_inventory hide">
						<div class="inventory_list">
							
						</div>
						<div class="equipped_item">
							
						</div>
					</div>
					<div class="active_unit_inventory hide">
						<div class="inventory_list">
							
						</div>
						<div class="equipped_item">
							
						</div>
					</div>
					<div class="quest hide">
						<div class="quest_list">
							<ul class="in_progress_quest">
								
							</ul>
							<ul class="complete_quest">
								
							</ul>
						</div>
						<div class="quest_detail">
							<div class="quest_header">
								<div class="quest_name">
								</div>
								<div class="quest_npc">
								</div>
							</div>
							<div class="quest_desc">
							</div>
							<div class="quest_reward">
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="location_list_frame">
			<div class="location_list_window hide">
				<div style="position:absolute;right:0"><input type="button" class="close" value="닫기"></div>
				<div class="location_category">
					<ul>
						<li id="sub_location">현재 지역</li><li id="move_location">다른 지역</li>
					</ul>
				</div>
				<div class="location_list">
					<ul>
						
					</ul>
				</div>
			</div>
		</div>
		<div class="visit_list_frame">
			<div class="visit_list_window">
				<div style="position:absolute;right:0"><input type="button" class="close" value="닫기"></div>
				<div class="visit_list">
					<ul>
						<li class="select_visit_npc" id="npc_0"><img src="npc/npc.png"><div class="npc_name">NPC1</div></li>
						<li class="select_visit_npc" id="npc_1"><img src="npc/npc.png"><div class="npc_name">NPC2</div></li>
					</ul>
				</div>
			</div>
		</div>
		<script src="/js/jquery.min.js"></script>
		<script src="/js/jquery-ui.min.js"></script>
		<script src="game.js"></script>
		<script>
			$(window).on('beforeunload', function(event)
			{
				//$('#save').click();
			});
			
			$("#test").click(function(event)
			{
				event.preventDefault();
				$("#dialogue").click();
				//convertType(active_unit);
			});
			$("#visit").click(function(event)
			{
				for(var i = 0; i < npcs_info.length; i++)
				{
					$(".visit_list > ul").append("<li class='select_visit_npc' id='npc_"+i+"'><img src='npc/npc.png'><div class='npc_name'>"+npcs_info[i]['name']+"</div></li>");
				}
				$(".visit_list_window").removeClass("hide");
			});
			$("body").on("click", ".select_visit_npc", function()
			{
				
			});
			var quest_condition = {nothing:0, first_meet:1, in_progress_quest:2, complete_quest:3, incomplete_quest:4, check_stat:5};
			var event_dialogue = {nothing:1, next_dialogue:2, move_location:3, give_item:4, give_money:5, change_npc:6, give_effect:7, add_quest:8, complete_quest:9};
			var quest_complete_condition = {nothing:0, visit_npc:1, visit_location:2, give_item:3, give_money:4, kill_npc:5};
			var cur_dialogue;
			var changeDialogue = function(dialogue_id)
			{
				$(".dialogue_content").text("");
				$(".dialogue_select > ul").empty();
				$.ajax({
					url:"dialogue.json",
					dataType:"json",
					type:"post",
					success:function(result)
					{
						cur_dialogue = result[dialogue_id];
						$(".dialogue_content").text(active_unit['char_name']+" : "+result[dialogue_id]['content']);
						for(var answer in result[dialogue_id]['answer'])
						{
							$(".dialogue_select > ul").append("<li class='select_answer' id='"+answer+"'>"+result[dialogue_id]['answer'][answer]['answer_content']+"</li>");
						}
					}
				});
			}
			var finishDialogue = function()
			{
				$(".dialogue_content").text("");
				$(".dialogue_select > ul").empty();
			}
			var firstDialogue = function(target)
			{
				var target = target || active_unit;
				$(".dialogue_content").text("");
				$(".dialogue_select > ul").empty();
				$(".dialogue_content").text(target['char_name']+" : 무슨 일이신가요?");
				//$(".dialogue_select > ul").append("<li class='first_answer' id='trade'>거래</li>");
				$(".dialogue_select > ul").append("<li class='first_answer' id='quest'>퀘스트</li>");
				$(".dialogue_select > ul").append("<li class='first_answer' id='ip_quest'>진행 퀘스트</li>");
				$(".dialogue_select > ul").append("<li class='first_answer' id='quit'>X</li>");
			}
			$("body").on("click", ".first_answer", function(event)
			{
				$(".dialogue_select > ul").empty();
				if($(this).attr("id") == "quest")
				{
					$.ajax({
					url:"quest.json",
					dataType:"json",
					type:"post",
					async:false,
					success:function(result)
					{
						for(var j = 0; j < active_unit['quest'].length; j++)
						{
							for(var i = 0; i < player['quest_state']['in_progress'].length; i++)
							{
								if(player['quest_state']['in_progress'][i] == active_unit['quest'][j])
								{
									changeDialogue(result[active_unit['quest'][j]]['progress_dialogue']);
									return;
								}
							}
							for(var i = 0; i < player['quest_state']['complete'].length; i++)
							{
								if(player['quest_state']['complete'][i] == active_unit['quest'][j])
								{
									continue;
								}
							}
							changeDialogue(result[active_unit['quest'][j]]['begin_dialogue']);
						}
					}
					});
				}
				else if($(this).attr("id") == "ip_quest")
				{
					$(".dialogue_select > ul").append("<li class='first_answer' id='back'>"+"뒤로"+"</li>");
					for(var quest in quests_info['in_progress_quest'])
					{
						checkCondition(quests_info['in_progress_quest'][quest]);
						if(quests_info['in_progress_quest'][quest]['complete'] == 1) $(".dialogue_select > ul").append("<li class='ip_quest_answer' id='"+quest+"'>"+quests_info['in_progress_quest'][quest]['name']+"</li>");
					}
				}
				else if($(this).attr("id") == "quit")
				{
					$(".dialogue_content").text("");
				}
				else if($(this).attr("id") == "back")
				{
					firstDialogue();
				}
			});
			$("body").on("click", ".ip_quest_answer", function(event)
			{
				$(".dialogue_select > ul").empty();
				console.log(quests_info['in_progress_quest'][$(this).attr("id")]);
				changeDialogue(quests_info['in_progress_quest'][$(this).attr("id")]['complete_dialogue']);
			});
			var checkCondition = function(quest)
			{
				var complete_state = 1;
				for(var i = 0; i < quest['complete_condition'].length; i++)
				{
					if(quest['complete_condition'][i]['event'] == quest_complete_condition['visit_npc'])
					{
						if(active_unit['id'] == quest['complete_condition'][i]['condition']['npc'])
						{
							quest['complete_condition'][i]['state'] = 1;
						}
						else complete_state = 0;
					}
					else if(quest['complete_condition'][i]['event'] == quest_complete_condition['visit_location'])
					{
						if(cur_location == quest['complete_condition'][i]['condition']['location'])
						{
							quest['complete_condition'][i]['state'] = 1;
						}
						else complete_state = 0;
					}
					else if(quest['complete_condition'][i]['event'] == quest_complete_condition['give_item'])
					{
						for(var item in player.inventory)
						{
							if(player.inventory[item] == quest['complete_condition'][i]['condition']['item'] && active_unit['id'] == quest['complete_condition'][i]['condition']['npc'])
							{
								quest['complete_condition'][i]['state'] = 1;
								break;
							}
						}
						if(quest['complete_condition'][i]['state'] != 1) complete_state = 0;
					}
					else if(quest['complete_condition'][i]['event'] == quest_complete_condition['give_money'])
					{
						if(player.money >= quest['complete_condition'][i]['condition']['money'] && active_unit['id'] == quest['complete_condition'][i]['condition']['npc'])
						{
							quest['complete_condition'][i]['state'] = 1;
						}
						else complete_state = 0;
					}
					else if(quest['complete_condition'][i]['event'] == quest_complete_condition['kill_npc'])
					{
						
					}
				}
				if(complete_state == 1)
				{
					console.log(1);
					quest['complete'] = 1;
				}
			}
			$("body").on("click", ".select_answer", function(event)
			{
				$(this).parent().empty();
				if(cur_dialogue['answer'][$(this).attr("id")]['answer_event_type'] == event_dialogue['nothing'])
				{
					$(".dialogue_content").text("");
				}
				else if(cur_dialogue['answer'][$(this).attr("id")]['answer_event_type'] == event_dialogue['next_dialogue'])
				{
					$(".dialogue_content").text("");
					changeDialogue(cur_dialogue['answer'][$(this).attr("id")]['answer_event']);
				}
				else if(cur_dialogue['answer'][$(this).attr("id")]['answer_event_type'] == event_dialogue['add_quest'])
				{
					$(".dialogue_content").text("");
					addQuest(cur_dialogue['answer'][$(this).attr("id")]['answer_event']);
				}
				else if(cur_dialogue['answer'][$(this).attr("id")]['answer_event_type'] == event_dialogue['complete_quest'])
				{
					$(".dialogue_content").text("");
					completeQuest(cur_dialogue['answer'][$(this).attr("id")]['answer_event']);
				}
			});
			$("#dialogue").click(function(event)
			{
				/*for(var val in quests_info['in_progress_quest'])
				{
					if(quests_info['in_progress_quest'][val]['complete_condition'] === undefined) quests_info['in_progress_quest'][val]['complete_condition'] = [];
					for(var i = 0; i < quests_info['in_progress_quest'][val]['complete_condition'].length; i++)
					{
						if(quests_info['in_progress_quest'][val]['complete_condition'][i]['event'] == 1)
						{
							if(active_unit['id'] == quests_info['in_progress_quest'][val]['complete_condition'][i]['condition'])
							{
								quests_info['in_progress_quest'][val]['complete_condition'][i]['state'] = 1;
							}
						}
					}
				}*/
				firstDialogue(active_unit);
			});
			var quests_info = {in_progress_quest:{}, complete_quest:{}};
			var addQuest = function(quest_id)
			{
				$.ajax({
					url:"quest.json",
					dataType:"json",
					type:"post",
					success:function(result)
					{
						quests_info['in_progress_quest'][quest_id] = result[quest_id];
						player['quest_state']['in_progress'].push(quest_id);
						$('.quest_list > ul.in_progress_quest').append("<li class='select_quest' id='quest_"+quest_id+"'>"+result[quest_id]['name']+"</li>");
					}
				});
			}
			var completeQuest = function(quest_id)
			{
				for(var i = 0; i < quests_info['in_progress_quest'][quest_id]['complete_condition'].length; i++)
				{
					if(quests_info['in_progress_quest'][quest_id]['complete_condition'][i]['event'] == quest_complete_condition['give_item'])
					{
						var item_id;
						for(var val in player.inventory)
						{
							if(player.inventory[val] == quests_info['in_progress_quest'][quest_id]['complete_condition'][i]['condition']['item'])
							{
								item_id = val;
								break;
							}
						}
						delItem(player, item_id);
					}
					else if(quests_info['in_progress_quest'][quest_id]['complete_condition'][i]['event'] == quest_complete_condition['give_money'])
					{
						player.money -= quests_info['in_progress_quest'][quest_id]['complete_condition'][i]['condition']['money']
					}
				}
				for(var val in quests_info['in_progress_quest'][quest_id]['reward'])
				{
					if(val == "exp")
					{
						gainExpPlayer(parseInt(quests_info['in_progress_quest'][quest_id]['reward'][val]));
					}
					else if(val == "money")
					{
						player.money += parseInt(quests_info['in_progress_quest'][quest_id]['reward'][val]);
					}
				}
				reload(player);
				if(quests_info['complete_quest'][quest_id] === undefined) quests_info['complete_quest'][quest_id] = {};
				for(var val in quests_info['in_progress_quest'][quest_id])
				{
					quests_info['complete_quest'][quest_id][val] = quests_info['in_progress_quest'][quest_id][val];
				}
				delete quests_info['in_progress_quest'][quest_id];
				$('.quest_list > ul.in_progress_quest > li#quest_'+quest_id).remove();
				$('.quest_list > ul.complete_quest').append("<li class='select_quest' id='quest_"+quest_id+"'>[완료]"+quests_info['complete_quest'][quest_id]['name']+"</li>")
			}
			$("body").on("click", ".select_quest", function()
			{
				var quest_info = quests_info[$(this).parents("ul").attr("class")][$(this).attr("id").split("_")[1]];
				$(".quest_name").text(quest_info['name']);
				$(".quest_desc").text(quest_info['desc']);
				//$(".quest_name").text(quest_info['name']);
				//$(".quest_name").text(quest_info['name']);
			});
			// SAVE LOAD STARTGAME
			/*$('#startgamebt').click(function()
			{
				event.preventDefault();*/
			$(document).ready(function()
			{
				player = new Player();
				player.createPlayer();
				player.char_name = "asdf";
				$('.player_list').append(player['char_name']+" <span id='hp'>"+player['hp']+"</span>/<span id='max_hp'>"+player['max_hp']+"</span>");
				$(".startgame").addClass("hide");
				giveItem(player, 0);
				giveItem(player, 1);
				giveItem(player, 2, 2);
				giveItem(player, 3, 1);
				giveItem(player, 4);
				giveItem(player, 5);
				reload(player);
				addQuest(1);
				moveLocation(0);
				$("#explore").click();
				if(active_unit.sp > 0) $(".inc_stat").removeClass("hide");
				//$("#test").click();
			});
		</script>
	</body>
</html>