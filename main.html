<html>
	<head>
		<meta charset="utf-8">
		<link type="text/css" href="style.css" rel="stylesheet">
	</head>
	<body>
		<style id="movebg">
			@keyframes movebg
			{
				from{background-position:0px 0px;}
				to{background-position:-500px 0px;}
			}
		</style>
		<div class="startgame">
			<input type="button" id="startgamebt" value="게임시작">
		</div>
		<div class="front">
		</div>
		<div class="frame">
			<div class="player_info_frame">
				<div class="player_info">
					<div class="player_info_name">
						<span id="char_name">?</span>
					</div>
					<center>
					<input type="button" id="save" value="저장">
					<input type="button" id="load" value="불러오기">
					</center>
					<div class="player_info_lvlxp">레벨 : <span id="level">0</span> 경험치 : <span id="exp_level">0</span>/<span id="lvlup_exp">0</span></div>
					<div class="player_info_stat">
						<div class="player_stat">힘 : <span id="stat_str">0</span><br>민첩 : <span id="stat_agi">0</span><br>지능 : <span id="stat_int">0</span><br>인내 : <span id="stat_end">0</span></div>
						<div class="inc_stat hide"><input type="button" id="stat_str" value="+"><br><input type="button" id="stat_agi" value="+"><br><input type="button" id="stat_int" value="+"><br><input type="button" id="stat_end" value="+"></div>
						SP : <span id="sp">0</span><br>
						HP : <span id="hp">0</span> / <span id="max_hp">0</span><br>MP : <span id="mp">0</span> / <span id="max_mp">0</span><br>공격력 : <span id="ad">0</span><br>공격속도 : <span id="as">0</span><br>
						방어력 : <span id="armor">0</span><br>마법저항력 : <span id="resist">0</span><br>돈 : <span id="money">0</span>
					</div>
				</div>
			</div>
			<div class="player_list">
				<ul>
				
				</ul>
			</div>
			<div class="player_effect">
				<ul>
				
				</ul>
			</div>
			<div class="npc_info_frame">
				<div class="npc_info">
					<ul>
						
					</ul>
					<div class="npc_info_name">
						<span id="char_name">?</span>
					</div>
					<div class="npc_info_lvlxp">레벨 : <span id="level">?</span></div>	
					<div class="npc_info_stat">
						<div class="npc_stat">힘 : <span id="stat_str">?</span><br>민첩 : <span id="stat_agi">?</span><br>지능 : <span id="stat_int">?</span><br>인내 : <span id="stat_end">?</span></div><br>
						HP : <span id="hp">?</span> / <span id="max_hp">?</span><br>MP : <span id="mp">?</span> / <span id="max_mp">?</span><br>공격력 : <span id="ad">?</span><br>공격속도 : <span id="as">?</span><br>
						방어력 : <span id="armor">?</span><br>마법저항력 : <span id="resist">?</span>
					</div>
				</div>
			</div>
			<div class="npc_list">
				<ul>
					
				</ul>
			</div>
			<div class="gamescreen">
				<div class="location_info">
					<div class="location_name">
					</div>
				</div>
				<div class="background">
					<div class="bgimg"></div>
				</div>
				<div class="dialogue_frame">
					<div class="dialogue_text">
						<div class="dialogue_name">
						</div>
						<div class="dialogue_content">
						</div>
					</div>
				</div>
			</div>
			<div class="location_progress">
				<div class="dialogue_text">
					<div class="dialogue_name">
					</div>
					<div class="dialogue_content">
					</div>
				</div>
			</div>
			<div class="user_control">
				<div class="control_category">
					<ul>
						<a href="#" id="controlbox"><li class="active">명령</li></a><a href="#" id="inventory"><li>인벤토리</li></a><a href="#" id="quest"><li>퀘스트</li></a>
					</ul>
				</div>
				<div class="controlscreen">
					<div class="controlbox">
						<input type="button" id="test" value="TEST">
						<input type="button" id="explore" value="탐험">
						<input type="button" id="attack" value="공격">
						<input type="button" id="dialogue" value="대화">
						<input type="button" class="hide" id="main_location" value="나가기">
						<input type="button" class="hide" id="move_location" value="지역 이동">
					</div>
					<div class="inventory hide">
						<div class="inventory_list">
							
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="location_list_frame">
			<div class="location_list_window hide">
				<div style="position:absolute;right:0"><input type="button" class="close" value="닫기"></div>
				<div class="location_category">
					<ul>
						<a href="#" id="sub_location"><li>현재 지역</li></a><a href="#" id="move_location"><li>다른 지역</li></a>
					</ul>
				</div>
				<div class="location_list">
					<ul>
						
					</ul>
				</div>
			</div>
		</div>
		<script src="/js/jquery.min.js"></script>
		<script src="/js/jquery-ui.min.js"></script>
		<script src="game.js"></script>
		<script>
			$(window).on('beforeunload', function(event)
			{
				//$('#save').click();
			});
			
			$("#test").click(function(event)
			{
				event.preventDefault();
				//convertType(active_npc);
			});
			
			var reloadInventory = function(target)
			{
				$(".inventory_list").empty();
				for(var i = 0; i < target.inventory.length; i++)
				{
					var item_id = target.inventory[i]['id'];
					var item_name = target.inventory[i]['name'];
					var item_image = "/item/"+target.inventory[i]['image'];
					var item_desc = target.inventory[i]['desc'];
					var item_effects = target.inventory[i]['item_effect'];
					var item_effect = "<li>";
					for(var j = 0; j < item_effects.length; j++)
					{
						if(item_effects[j]['type'] == "ad") item_effect += "공격력";
						else if(item_effects[j]['type'] == "as") item_effect += "공격속도";
						else if(item_effects[j]['type'] == "hp") item_effect += "HP";
						else if(item_effects[j]['type'] == "mp") item_effect += "MP";
						else if(item_effects[j]['type'] == "ms") item_effect += "이동속도";
						else if(item_effects[j]['type'] == "armor") item_effect += "방어력";
						else if(item_effects[j]['type'] == "resist") item_effect += "마법저항력";
						else if(item_effects[j]['type'] == "stat_str") item_effect += "힘";
						else if(item_effects[j]['type'] == "stat_agi") item_effect += "민첩";
						else if(item_effects[j]['type'] == "stat_int") item_effect += "지능";
						else if(item_effects[j]['type'] == "stat_end") item_effect += "인내";
						if(item_effects[j]['id'] == magic_effect_id["buff"])
						{
							item_effect += "+";
						}
						else if(item_effects[j]['id'] == magic_effect_id["debuff"])
						{
							item_effect += "-";
						}
						item_effect += item_effects[j]['intensity']+(item_effects[j]['intensity_type']=="percent"?"%":"");
					}
					var item_slot;
					if(target.inventory[i]['equip_slot'] == "head")
					{
						item_slot = "투구";
					}
					else if(target.inventory[i]['equip_slot'] == "u_body")
					{
						item_slot = "갑옷";
					}
					else if(target.inventory[i]['equip_slot'] == "l_body")
					{
						item_slot = "바지";
					}
					else if(target.inventory[i]['equip_slot'] == "a_hands")
					{
						item_slot = "장갑";
					}
					else if(target.inventory[i]['equip_slot'] == "foot")
					{
						item_slot = "신발";
					}
					else if(target.inventory[i]['equip_slot'] == "w_hands")
					{
						item_slot = "무기";
					}
					item_effect += "</li>";
					//$(".inventory_list > ul").append("<a href='#' class='select_item' id='item_"+i+"'><li>"+target.inventory[i]['name']+"</li></a>")
					//$(".inventory_list").append('<div class="inventory_item"><div class="item_header"><span>'+item_name+' '+item_slot+'</span></div><div class="item_content"><span>'+item_desc+'</span></div></div>');
					$(".inventory_list").append('<div class="inventory_item"><a href="#" class="select_item" id="item_'+i+'"><div class="inventory_image"><img src="'+item_image+'"></div></a></div><div class="item_detail hide"><div class="item_header"><div class="item_name">'+item_name+'</div><div class="item_slot">'+item_slot+'</div></div><div class="item_content"><div class="h_line"></div><div class="item_desc">'+item_desc+'</div><div class="h_line"></div><div class="item_effect"><ul>'+item_effect+'</ul></div></div></div></div>');
					for(var slot in target.equip_slot)
					{
						if(target.equip_slot[slot] == i)
						{
							$(".select_item#item_"+i).parent().addClass("equipped");
						}
					}
				}
			}
			$("body").on({
			mouseenter : function(event)
			{
				var left = $(this).parent().offset()['left']-$(".controlscreen").offset()['left'];
				$(this).parent().css("z-index", "2");
				$(this).parent().next().removeClass("hide");
				$(this).parent().next().css("left", left);
			},
			mouseleave : function(event)
			{
				$(this).parent().css("z-index", "0");
				$(this).parent().next().addClass("hide");
			}}, ".select_item");
			$("body").on("click",".select_item",function(event)
			{
				event.preventDefault();
				equipItem(active_player, $(this).attr("id").split("_")[1]);
			});
			var equipItem = function(target, item)
			{
				var item_id =  item;
				var item = target.inventory[item_id];
				var equip_state = 0;
				for(var slot in target.equip_slot)
				{
					if(slot == item.equip_slot)
					{
						if(target.equip_slot[slot] == "none")
						{
							target.equip_slot[slot] = item_id;
							equip_state = 1;
						}
						else if(target.equip_slot[slot] == item_id)
						{
							target.equip_slot[slot] = "none";
							equip_state = 2;
						}
						else
						{
							equipItem(target, target.equip_slot[slot]);
							target.equip_slot[slot] = item_id;
							equip_state = 1;
						}
						break;
					}
				}
				if(equip_state == 1)
				{
					for(var i = 0; i < item.item_effect.length; i++)
					{
						if(item.item_effect[i] === undefined) item.item_effect[i] = {};
						if(item.item_effect[i]['id'] == magic_effect_id['buff'])
						{
							if(item.item_effect[i]['intensity_type'] == "value")
							{
								target[item.item_effect[i]['type']] += parseInt(item.item_effect[i]['intensity']);
							}
							else
							{
								target[item.item_effect[i]['type']] += (parseInt(item.item_effect[i]['intensity'])*0.01)*target["base_"+item.item_effect[i]['type']];
							}
						}
						else if(item.item_effect[i]['id'] == magic_effect_id['debuff'])
						{
							if(item.item_effect[i]['intensity_type'] == "value")
							{
								target[item.item_effect[i]['type']] -= parseInt(item.item_effect[i]['intensity']);
							}
							else
							{
								target[item.item_effect[i]['type']] -= (parseInt(item.item_effect[i]['intensity'])*0.01)*target["base_"+item.item_effect[i]['type']];
							}
						}
						reload(target, item.item_effect[i]['type']);
					}
					$(".select_item#item_"+item_id).parent().addClass("equipped");
				}
				else if(equip_state == 2)
				{
					for(var i = 0; i < item.item_effect.length; i++)
					{
						if(item.item_effect[i]['id'] == magic_effect_id['buff'])
						{
							if(item.item_effect[i]['intensity_type'] == "value")
							{
								target[item.item_effect[i]['type']] -= parseInt(item.item_effect[i]['intensity']);
							}
							else
							{
								target[item.item_effect[i]['type']] -= (parseInt(item.item_effect[i]['intensity'])*0.01)*target["base_"+item.item_effect[i]['type']];
							}
						}
						else if(item.item_effect[i]['id'] == magic_effect_id['debuff'])
						{
							if(item.item_effect[i]['intensity_type'] == "value")
							{
								target[item.item_effect[i]['type']] += parseInt(item.item_effect[i]['intensity']);
							}
							else
							{
								target[item.item_effect[i]['type']] += (parseInt(item.item_effect[i]['intensity'])*0.01)*target["base_"+item.item_effect[i]['type']];
							}
						}
						reload(target, item.item_effect[i]['type']);
					}
					$(".select_item#item_"+item_id).parent().removeClass("equipped");
				}
			}
			var giveItem = function(target, id)
			{
				$.ajax({
					url:"item.json",
					dataType:"json",
					type:"post",
					async:false,
					success:function(result)
					{
						target.inventory.push(result[id]);
					}
				});
			}
			// SAVE LOAD STARTGAME
			/*$('#startgamebt').click(function()
			{
				event.preventDefault();*/
			$(document).ready(function()
			{
				player = new Player();
				player.createPlayer();
				player.char_name = "asdf";
				$('.player_list > ul').append("<a href='#' class='select_player' id='player'><li id='player'>"+player['char_name']+" <span id='hp'>"+player['hp']+"</span>/<span id='max_hp'>"+player['max_hp']+"</span></li></a>");
				$(".startgame").addClass("hide");
				$(".select_player")[0].click();
				giveItem(player, 2);
				giveItem(player, 1);
				giveItem(player, 0);
				giveItem(player, 3);
				reloadInventory(player);
				reload(active_player);
				moveLocation(0);
				if(active_player.sp > 0) $(".inc_stat").removeClass("hide");
				$("#test").click();
				$("#inventory").children()[0].click();
			});
		</script>
	</body>
</html>